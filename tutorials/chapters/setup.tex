\chapter{Setup}\label{chap:Setup}
\section{Introduction}\label{sec:Introduction}
This document is intended to serve as a record of the work performed for the ECE 497 special project supervised by Professor Jia Wang during the Spring 2021 semester.
In this document, we will specify how our project repository was created, outline issues we ran into, and provide guidance on how to better setup the Chipyard Framework.

\section{Project Environment}\label{chap:Project_Environment}
The first step to using the Chipyard Framework is creating a project environment and obtaining all of the Chipyard dependencies.
In this document, we assume you are using Ubuntu 20.04 LTS, running in a virtual machine with at least:
\begin{itemize}
\item 4 cores
\item \SI{8}{\giga\byte} of RAM
\item \SI{250}{\giga\byte} disk image
\end{itemize}

Much of the disk space that has been allocated will be utilized, as the entire RISC-V toolchain and Xilinx Vivado suite require a large amount of disk space.

This document will work equally well in other distributions, so long as the versions of the dependencies are matched.
Chipyard also has explicit support for CentOS, which extends to Fedora and RHEL as well.
In addition, installing and using Linux natively works as well.

\section{Building Chipyard}\label{sec:Building_Chipyard}
Here, we present the necessary steps to retrieving all the dependencies required to set up Chipyard for local development and simulation use.
All of the code shown in the listings of this section is gathered in the \file{code} subdirectory.

\subsection{Chipyard Dependencies}\label{sec:Chipyard_Dependencies}
To gather the Chipyard dependencies, follow the \href{https://chipyard.readthedocs.io/en/latest/}{Chipyard} documentation closely.
Specifically, the \href{https://chipyard.readthedocs.io/en/latest/Chipyard-Basics/Initial-Repo-Setup.html}{Section 1.4} of the documentation outlines how to prepare your operating system for development using the Chipyard framework.

A paraphrased reproduction of these steps are shown below.

\subsubsection{Retrieve/Install Dependencies}\label{sec:Retrive_Install_Dependencies}
Chipyard relies on numerous dependencies and libraries to read files and build the required Verilog files.
In addition, Chipyard relies on \texttt{sbt}, the Scala Build Tool, as a majority of Chipyard and its dependencies are written in Scala.

\Cref{lst:Ubuntu_Chipyard_Deps_Setup} is a script that handles fetching and installing all the dependencies for you.
Note that this does \textbf{not} work for installing the dependencies for Linux distributions that do not use the \texttt{apt} package manager.

\begin{listing}[h!tbp]
\bashsourcefile{./code/ubuntu-chipyard-deps-setup.sh}
\caption{Fetch Chipyard Dependencies using \texttt{apt} on Ubuntu}
\label{lst:Ubuntu_Chipyard_Deps_Setup}
\end{listing}

\subsubsection{Build Verilator from Source}\label{sec:Build_Verilator_from_Source}
Chipyard's documentation recommends building \href{https://www.veripool.org/wiki/verilator}{Verilator} (an open-source (System)Verilog simulator and compiler) from source.

A small script has been provided that handles this for you in \Cref{lst:Build_Verilator_from_Source}.
Note that this does \textbf{not} work for installing the dependencies required to build Verilator for Linux distributions that do not use the \texttt{apt} package manager.

\begin{listing}[h!tbp]
\bashsourcefile{./code/build-verilator.sh}
\caption{Building Verilator from Source}
\label{lst:Build_Verilator_from_Source}
\end{listing}

\subsubsection{Fetching Chipyard and its Direct Dependencies}\label{sec:Fetching_Chipyard_Direct_Dependencies}
In addition to the library and external programs that Chipyard depends on, it also uses git submodules to track direct dependencies.
Direct dependencies are projects that Chipyard directly relies on.
These include SiFive's CPU designs, the BOOM CPU design, rocket-chip, and several others.

\Cref{lst:Fetch_Chipyard_and_Submodules} has been provided that handles this for you.

\begin{listing}[h!tbp]
\bashsourcefile{./code/fetch-chipyard-and-submodules.sh}
\caption{Fetch Chipyard and Submodules}
\label{lst:Fetch_Chipyard_and_Submodules}
\end{listing}

\subsubsection{Building a Toolchain}\label{sec:Building_Toolchain}
To compile programs from C to RISC-V instructions, there are several tools you need, when grouped together is called a toolchain.
Your cloned Chipyard repository contains a script to install these.
You can run the script to build a good general-purpose toolchain using \bashinline{./scripts/build-toolchains.sh riscv-tools} while inside your local copy of the cloned Chipyard repository.

\subsubsection{Environment Variables}\label{sec:Environment_Variables}
Once the toolchain is built, an environment-setup script is emitted to the root of your local copy of Chipyard, with the name \file{env.sh}.
This file is a bash script that changes your \texttt{PATH}, \texttt{RISCV}, and \texttt{LD\_LIBRARY\_PATH} environment variables so that Chipyard can find everything it needs.

To alleviate any issues that may occur due to misconfigured or non-existent environment variables, there are two possible quality of life improvements you can make.
\begin{enumerate}
\item Add the line \mintinline{bash}{source /path/to/chipyard/env.sh} to your \texttt{.bashrc} file in your home directory.
  After adding this to your \texttt{.bashrc} file, restart your shell, or re-\texttt{source} your \file{.bashrc} and continue.
\item Install the \href{https://direnv.net/}{\texttt{direnv}} package and use it to automatically change your environment variables for you, instead of having them constantly loaded the way the previous option does.
\end{enumerate}

\subsection{Xilinx Vivado Suite Installation}\label{sec:Xilinx_Vivado_Suide_Install}
The \href{https://www.xilinx.com/support/download.html}{Xilinx Vivado Suite} is important to be installed if any work regarding an FPGA is to be conducted.
While performing this work and preparing this document, we used the ``offline installation'' version of the Xilinx Unified Installer (version 2020.2), so no \nth{3} party libraries would need to be installed.
Xilinx is supported for a variety for a variety of operating systems, including Ubuntu\footnote{Xilinx only officially offers support for Ubuntu 16.04.2 LTS, but it should work on any Ubuntu version since then.}
When conducting the installation, be sure to select the ``Vitis'' installation target instead of just selecting ``Vivado''.
Installing Vitis will install both Vivado, and all other Xilinx tools needed for implementing FPGA projects.

This repository is specifically meant for use with SiFive IP, but can still be utilized for Chipyard projects with some modification.

\subsection{Freedom Tools}
\hyperref{https://github.com/sifive/freedom-tools}{This repository} is maintained by SiFive, and is used to generate several tools that will be used during this project, such as the GCC cross-compiler for RISC-V (and many extension sets of RISC-V), OpenOCD, which assists users in debugging their FPGA designs, RISC-V QEMU, and other useful software.
These tools take a considerable amount of time and disk space to compile so it is best to run the \texttt{make} command as \mintinline{bash}{make -j`nproc`} to parallelize compiling.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../doc"
%%% End:
